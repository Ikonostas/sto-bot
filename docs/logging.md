# Система логирования STO Bot

## Общее описание

Система логирования настроена для работы в двух режимах:
- **Development** - подробное логирование для разработки
- **Production** - оптимизированное логирование для продакшена

## Структура логов

Логи разделены на три основных файла:

1. **error.log**
   - Содержит только ошибки (уровень ERROR и CRITICAL)
   - Сохраняется 30 дней
   - Подробный формат с путями и номерами строк
   - Ротация по времени (ежедневно)

2. **info.log**
   - Основная информация (уровень INFO)
   - Ротация по размеру (10 МБ)
   - Хранится 5 резервных копий
   - Упрощенный формат для продакшена

3. **debug.log**
   - Отладочная информация (уровень DEBUG)
   - Доступен только в режиме разработки
   - Ротация по размеру (5 МБ)
   - Хранится 3 резервные копии

## Настройка через переменные окружения

В файле `.env` можно настроить следующие параметры:

```env
# Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)
LOG_LEVEL=INFO

# Время хранения логов в днях
LOG_RETENTION_DAYS=30

# Максимальный размер лог-файла в МБ
LOG_MAX_SIZE_MB=10

# Количество резервных копий
LOG_BACKUP_COUNT=5

# Окружение (development или production)
ENVIRONMENT=production
```

## Форматы логов

### Режим разработки (ENVIRONMENT=development)
```
%(asctime)s - %(name)s - %(levelname)s - %(pathname)s:%(lineno)d - %(message)s
```
Пример:
```
2024-03-20 10:15:30,123 - sto_bot - INFO - /app/handlers/registration.py:45 - Пользователь 123456 начал регистрацию
```

### Режим продакшена (ENVIRONMENT=production)
```
%(asctime)s - %(levelname)s - %(message)s
```
Пример:
```
2024-03-20 10:15:30,123 - INFO - Пользователь 123456 начал регистрацию
```

## Использование в коде

```python
from utils.logger import get_logger

logger = get_logger()

# Разные уровни логирования
logger.debug("Подробная отладочная информация")
logger.info("Обычное информационное сообщение")
logger.warning("Предупреждение")
logger.error("Ошибка")
logger.critical("Критическая ошибка")

# Логирование с контекстом
logger.info("Пользователь %s выполнил действие %s", user_id, action)

# Логирование исключений
try:
    # код, который может вызвать исключение
    pass
except Exception as e:
    logger.error("Ошибка при обработке запроса", exc_info=True)
```

## Рекомендации по использованию

### В режиме разработки
1. Установите `LOG_LEVEL=DEBUG`
2. Установите `ENVIRONMENT=development`
3. Все логи будут выводиться в консоль и в файлы

### В продакшене
1. Установите `LOG_LEVEL=INFO`
2. Установите `ENVIRONMENT=production`
3. Настройте периодическую очистку старых логов через cron:
```bash
0 0 * * * /usr/bin/python3 /path/to/your/app/cleanup_logs.py
```

## Очистка старых логов

Для очистки старых логов можно использовать метод `cleanup_old_logs`:
```python
from utils.logger import logger_setup

# Очистка логов старше 30 дней
logger_setup.cleanup_old_logs(days=30)
```

## Мониторинг логов

### В режиме разработки
```bash
# Просмотр всех логов в реальном времени
tail -f logs/*.log

# Просмотр только ошибок
tail -f logs/error.log

# Просмотр информационных сообщений
tail -f logs/info.log
```

### В продакшене
```bash
# Просмотр ошибок
tail -f logs/error.log

# Просмотр информационных сообщений
tail -f logs/info.log
```

## Рекомендации по анализу логов

1. **Регулярная проверка error.log**
   - Ежедневно проверяйте наличие новых ошибок
   - Анализируйте причины возникновения ошибок

2. **Мониторинг размера логов**
   - Следите за размером лог-файлов
   - При необходимости настройте более агрессивную ротацию

3. **Анализ производительности**
   - Используйте логи для отслеживания времени выполнения операций
   - Выявляйте узкие места в работе приложения

4. **Безопасность**
   - Регулярно проверяйте логи на наличие подозрительной активности
   - Храните логи в безопасном месте
   - Настройте правильные права доступа к лог-файлам 