# Реализация Админ-панели

## Обзор реализации

В соответствии с требованиями технического задания была разработана административная панель бота, которая предоставляет расширенные возможности для пользователей с ролью "Администратор". Админ-панель доступна через главное меню бота и состоит из двух основных разделов: "Согласование" и "Список агентов".

## Реализованные функции

### 1. Раздел "Согласование"

Функционал этого раздела включает:
- Просмотр списка активных карточек ТО, ожидающих согласования
- Пагинацию для удобного просмотра карточек (по 5 карточек на странице)
- Подробное отображение информации по каждой карточке
- Возможность согласовать карточку ТО одним нажатием
- Возможность отклонить карточку ТО с указанием причины отклонения
- Автоматическое уведомление агента о результате согласования

#### Файлы:
- `handlers/admin_approvals.py` - основная логика раздела согласований
- `handlers/menu.py` - интеграция с меню бота

### 2. Раздел "Список агентов"

Функционал этого раздела включает:

#### 2.1. Просмотр списка агентов
- Отображение списка всех агентов системы
- Пагинация для удобного просмотра (по 30 агентов на странице)
- Возможность выбора конкретного агента для дальнейших действий

#### 2.2. Информация об агенте (Info)
- Просмотр личных данных агента (ФИО, компания, телефон)
- Просмотр ссылки на мессенджер агента (если указана)
- Статистика по согласованным и отклоненным ТО
- Финансовая информация: баланс, процент комиссии, сумма комиссий, сумма выплат

#### 2.3. Архив агента (Archive)
- Просмотр всех карточек ТО агента (с пагинацией)
- Просмотр статусов каждой карточки
- Просмотр истории платежей агента с комментариями
- Детальная информация о каждой карточке и платеже

#### 2.4. Действия с агентом (Action)
- Добавление карточки расчета (положительные или отрицательные суммы)
- Редактирование существующих карточек ТО
- Изменение ставки комиссии агента с автоматическим пересчетом баланса

#### Файлы:
- `handlers/admin.py` - основная логика административных функций
- `handlers/menu.py` - интеграция с меню бота

## Особенности реализации

### Расчет баланса агента

Баланс агента рассчитывается по формуле, указанной в ТЗ:
```
Баланс = Сумма всех согласованных карточек ТО - Комиссия агента - Сумма выплат
```

Где:
- Сумма всех согласованных карточек ТО — суммарная стоимость всех карточек со статусом "Согласовано"
- Комиссия агента — процент комиссии, умноженный на сумму всех согласованных карточек
- Сумма выплат — сумма всех платежей, где положительные значения уменьшают баланс, а отрицательные увеличивают

### Удобство использования

1. Все действия с агентами и карточками ТО логируются в системе
2. Для удобства навигации интерфейс имеет кнопки "Назад" и "Вернуться в главное меню"
3. Реализована пагинация для длинных списков (агенты, карточки)
4. Использованы эмодзи для улучшения читаемости интерфейса
5. Все денежные значения форматируются с двумя десятичными знаками

### Структура обработчиков

Для организации процесса взаимодействия с пользователем использованы `ConversationHandler`, которые позволяют создавать диалоги с сохранением контекста между сообщениями.

## Документация

Для админ-панели создана подробная документация в файле `docs/ADMIN_PANEL.md`, которая описывает:
- Функциональность каждого раздела
- Процесс работы с карточками ТО и агентами
- Процесс расчета баланса агента
- Особенности и возможности системы

## Выводы

Реализованная админ-панель полностью соответствует требованиям технического задания и предоставляет администраторам системы все необходимые инструменты для управления агентами и карточками ТО. Использование асинхронных функций и структурированного подхода к организации кода обеспечивает высокую производительность и удобство сопровождения разработанного функционала. 