# Telegram Bot для записи на техническое обслуживание

Бот для управления записями на техническое обслуживание автомобилей с поддержкой множества станций обслуживания.

## Структура проекта

```
STO/
├── bot.py              # Основной файл бота
├── config.py           # Конфигурация
├── requirements.txt    # Зависимости
├── database/          # Работа с базой данных
│   ├── __init__.py
│   ├── db.py         # Настройки БД
│   └── models.py     # Модели данных
├── handlers/         # Обработчики команд
│   ├── __init__.py
│   ├── common.py    # Общие обработчики
│   ├── registration.py # Регистрация
│   ├── appointments.py # Управление записями
│   └── manager.py   # Функции менеджера
└── utils/           # Вспомогательные функции
    ├── __init__.py
    └── time_slots.py # Работа с временными слотами
```

## Функциональность

- Регистрация пользователей
- Создание записей на ТО
- Просмотр своих записей
- Управление записями (для менеджеров)
- Выбор станции ТО
- Выбор даты и времени
- Проверка доступности временных слотов

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/Ikonostas/sto-bot.git
cd sto-bot
```

2. Создайте файл с переменными окружения:
```bash
cp .env.example .env
```

3. Отредактируйте файл `.env`, указав необходимые значения:
- BOT_TOKEN - токен вашего Telegram бота
- DATABASE_URL - URL для подключения к базе данных
- LOG_LEVEL - уровень логирования
- ADMIN_IDS - список ID администраторов бота

4. Запустите приложение:
```bash
chmod +x deploy.sh
./deploy.sh
```

## Команды бота

- `/start` - Начало работы с ботом
- `/register` - Регистрация нового пользователя

## Требования

- Docker и Docker Compose
- Git
- Python 3.8+
- python-telegram-bot==20.7
- SQLAlchemy==2.0.23
- python-dotenv==1.0.0
- aiosqlite==0.19.0

## Разработка

1. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # для Linux/Mac
venv\Scripts\activate     # для Windows
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Запустите тесты:
```bash
python -m pytest tests/ -v
```

## База данных

### Таблицы

1. Users
   - telegram_id
   - username
   - full_name
   - company_name
   - is_registered
   - is_manager

2. Stations
   - name
   - address
   - slots_per_hour

3. Appointments
   - station_id
   - user_id
   - client_name
   - car_number
   - client_phone
   - appointment_time

## Основные функции

- Запись на техническое обслуживание
- Просмотр своих записей
- Управление записями (для менеджеров)
- Защита от дублирования записей
- Учет количества слотов для каждой станции

## Последние обновления

### Версия 1.2.0 (11.03.2024)
- Улучшена обработка ошибок во всех обработчиках
- Добавлена валидация данных при регистрации
- Исправлена проблема с закрытием сессий базы данных
- Добавлено подробное логирование ошибок
- Исправлена обработка кнопки "Назад к выбору даты"
- Добавлены проверки на существование пользователя
- Улучшена проверка наличия необходимых данных при записи
- Оптимизирована работа с базой данных
- Исправлены проблемы с зависанием бота

### Версия 1.1.0 (11.03.2024)
- Добавлена защита от двойных записей на одно время
- Улучшена проверка доступности временных слотов
- Добавлена кнопка "Назад" при выборе времени
- Добавлена проверка на прошедшее время
- Исправлен баг с отображением занятых слотов
- Добавлена обработка ошибок при сохранении записи

## Технические детали

- Python 3.8+
- python-telegram-bot 20.7
- SQLAlchemy 2.0.23
- SQLite база данных

## Структура временных слотов

- Рабочие часы: 9:00 - 18:00
- Интервал записи: 30 минут
- Количество слотов в час настраивается для каждой станции
- Автоматическая блокировка прошедшего времени
- Защита от дублирования записей на одно время

## Возможности

- Запись клиентов на техосмотр
- Просмотр существующих записей
- Управление записями для менеджеров
- Поддержка 10 разных станций ТО
- Гибкое расписание с интервалами в 30 минут

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/Ikonostas/sto-bot.git
cd sto-bot
```

2. Создайте файл с переменными окружения:
```bash
cp .env.example .env
```

3. Отредактируйте файл `.env`, указав необходимые значения:
- BOT_TOKEN - токен вашего Telegram бота
- DATABASE_URL - URL для подключения к базе данных
- LOG_LEVEL - уровень логирования
- ADMIN_IDS - список ID администраторов бота

4. Запустите приложение:
```bash
chmod +x deploy.sh
./deploy.sh
```

## Запуск

```bash
python bot.py
```

## Использование

1. Найдите бота в Telegram по его имени
2. Отправьте команду `/start`
3. Следуйте инструкциям бота для создания записи или просмотра существующих

## Для менеджеров

Чтобы получить права менеджера, необходимо установить флаг `is_manager=True` для соответствующего пользователя в базе данных.

## Безопасность

- Файл `.env` содержит конфиденциальные данные и не должен публиковаться в репозитории
- Используйте `.env.example` как шаблон для создания `.env`
- База данных `techservice.db` также исключена из репозитория

## Структура проекта

- `bot.py` - основной файл бота
- `models.py` - модели базы данных
- `init_stations.py` - скрипт инициализации станций
- `requirements.txt` - зависимости проекта
- `.env.example` - пример файла конфигурации
- `.gitignore` - список игнорируемых файлов

## Улучшение надежности и стабильности бота

## Описание изменений
В этом PR внесены следующие улучшения:

### Обработка ошибок
- Добавлена комплексная обработка ошибок во всех обработчиках
- Реализовано подробное логирование ошибок
- Улучшены сообщения об ошибках для пользователей

### Валидация данных
- Добавлена проверка длины ФИО (минимум 3 символа)
- Добавлена проверка длины названия компании (минимум 2 символа)
- Улучшена проверка наличия всех необходимых данных при создании записи

### Работа с базой данных
- Исправлена проблема с закрытием сессий базы данных
- Добавлены проверки на существование пользователя и станции
- Оптимизированы запросы к базе данных
- Добавлена обработка транзакций с корректным откатом при ошибках

### Навигация
- Исправлена обработка кнопки "Назад к выбору даты"
- Улучшена работа кнопки возврата в главное меню
- Добавлена корректная обработка отмены операций

### Безопасность
- Добавлены проверки на существование пользователя перед каждой операцией
- Улучшена защита от некорректных данных
- Добавлена проверка прав доступа

## Тестирование

Проект использует pytest для тестирования. Тесты написаны для основных функций:
- Регистрация пользователей
- Создание записей на ТО

### Запуск тестов

1. Установите зависимости для тестирования:
```bash
pip install -r requirements.txt
```

2. Запустите тесты:
```bash
python -m pytest tests/ -v
```

### Структура тестов

```
tests/
├── conftest.py           # Общие фикстуры и настройки
├── test_registration.py  # Тесты регистрации
└── test_appointments.py  # Тесты записи на ТО
```

### Написание новых тестов

При добавлении новой функциональности рекомендуется:
1. Создать новый файл с тестами в директории `tests/`
2. Использовать существующие фикстуры из `conftest.py`
3. Следовать паттерну именования `test_*.py`
4. Использовать декоратор `@pytest.mark.asyncio` для асинхронных тестов

## Версия
Обновлена версия до 1.2.0 

## Лицензия

MIT 