# STO Bot - Бот для записи на СТО

Телеграм-бот для записи на станции технического осмотра (СТО) с системой ролей и администрирования.

## Функциональность

### Роли пользователей
- **Агент** - базовая роль для записи на ТО
- **Администратор** - расширенная роль с дополнительными правами

### Основные возможности
1. **Запись на ТО**
   - Поддержка категорий B, C, E
   - Выбор СТО с разными ценами
   - Учет дефектов и дополнительных работ
   - Гибкая система временных слотов

2. **Управление записями**
   - Просмотр активных записей
   - Отмена записей
   - История операций
   - Расчет баланса и комиссий

3. **Админ-панель**
   - Согласование/отклонение записей
   - Управление агентами
   - Просмотр статистики
   - Изменение комиссий

## Установка и настройка

### Требования
- Python 3.8+
- PostgreSQL 12+
- DBeaver (опционально, для управления БД)

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Настройка базы данных
1. Создайте базу данных в PostgreSQL:
   - Имя базы данных: STO-BOT
   - Кодировка: UTF8
   - Правило сортировки: ru-RU

2. Настройте подключение в DBeaver:
   - Host: localhost
   - Port: 5432
   - Database: STO-BOT
   - Username: postgres
   - Password: [ваш пароль]

### Конфигурация
1. Создайте файл `.env` на основе `.env.example`:
```env
BOT_TOKEN=ваш_токен_бота
ADMIN_IDS=[id_админа]
DB_HOST=localhost
DB_PORT=5432
DB_NAME="STO-BOT"
DB_USER=postgres
DB_PASSWORD=ваш_пароль
REGISTRATION_CODE=секретный_код
```

2. Настройте параметры СТО в `.env`:
```json
STO_STATIONS={
    "station1": {
        "name": "СТО 1",
        "address": "ул. Примерная, 1",
        "categories": ["B", "C", "E"],
        "prices": {"B": 2000, "C": 3000, "E": 2000},
        "working_hours": {"start": "09:00", "end": "17:00"},
        "time_slot": 30,
        "defect_prices": {"minor": 1000, "major": 2000}
    }
}
```

## Запуск

1. Запустите бота:
```bash
python main.py
```

2. В Telegram найдите бота и начните диалог командой `/start`

## Использование

### Регистрация
1. Отправьте команду `/register`
2. Введите:
   - ФИО
   - Номер телефона
   - Компанию
   - Кодовое слово

### Запись на ТО
1. Выберите категорию (B, C, E)
2. Выберите СТО
3. Укажите наличие дефектов
4. Выберите время
5. Введите данные клиента

### Админ-функции
1. Согласование записей
2. Управление агентами
3. Просмотр статистики
4. Изменение комиссий

## Логирование

- Режим DEBUG (по умолчанию): подробное логирование в консоль
- Режим INFO: логирование в файл с ротацией при достижении 300MB

## Безопасность

- Валидация кодового слова при регистрации
- Проверка ролей для доступа к функциям
- Защита от SQL-инъекций
- Ограничение количества запросов

## Резервное копирование

База данных автоматически создает резервную копию каждый день в 22:00. 