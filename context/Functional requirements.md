# STO Bot - Бот для записи на СТО
Телеграмм бот для записи на станции технического осмотра (СТО). 
В Боте есть 2 типа роли пользователей. Агент (обычный пользователь) и Админ, имеет функционал агента, плюс дополнительные права. Список администраторов добавляется в конфигурационный файл бота. (Можно выбрать более оптимальный способ индефициорования и добавление пользователь с правами администратора.   
При первом запуске бота пользователю необходимо пройти регистрацию. Необходимые данные для регистрации: Фамилия имя отчество, номер телефона, компания в которой работаете, кодовое слово. На все поля валидация не нужна, нужно проверять только то, что кодовое слово совпало со словом в конфигурационным файле. После регистрации вывести информационное сообщение о регистрации и предложение о переходе в главное меню командой /start. В базу данных добавить сущность «Агент» с информацией об агенте и порядковым номером.
Функционал Бота:
Главное меню.
В главном меню отображать 5 сущности. Первые три блока — это «запись на ТО» категории В, С, Е соответственно и блок «Мои записи», «архив».
Запись на ТО.
1)	Зарегистрированный пользователь может произвести запись автомобилей 3 категорий (B, C, E) на СТО для получения диагностической карты. 
2)	 После выбора категории авто например: «В», агент выбирает адрес СТО. Каждая станция может принимать как все 3 категории авто, так и одну категорию, это должно прописываться в конфигурационном файле. Например «Грузовая-пассажирская д. 10», кроме того у каждой станции в зависимости от категории выбранного авто выводиться информации по стоимости проведения тех.осмотра (В - 2000,С - 3000,Е - 2000 соответственно). Эту информацию так же можно поменять для каждой станции в конфигурационном файле.
3)	После выбора категории авто и СТО, агент указывает о наличии дефектов. Дефектов нет, стоимость не меняется, есть незначительные дефекты для всех категорий плюс 1000 рублей к их первоначальной цене, значительные дефекты плюс 2000 рублей к цене и спросить какие дефекты на авто (комментарий к записи). Информация о доплате по каждой станции должна быть настраиваема в конфигурационном файле.
4)	Далее агент выбирает время проведения СТО. Важно учесть момент что агентов будет несколько и у них одинаковый набор станций и одинаковое время для записи, так что нужно отображать уже занятые временные промежутки. Режим работы СТО указывается в конфигурационном файле для каждой станции, так же там указывается временной промежуток записи в минутах (например  30 минут, значит что если станция работает с 9:00 до 17:00, то можно будет записаться на 9:00, 9:30, 10:00 и так далее.) 
5)	Следующим шагом бот по очереди спрашивает: Имя клиента, номер автомобиля, VIN номер авто, номер телефона клиента (на данный телефон вышлют диагностическую карту). Валидация введённых данных не производиться. 
6)	Последним шагом записи отправляется вся информация о записи (карточка ТО). И присвоить ей номер по логике «дата в формате DD.MM.YYYY + порядковый номер агента умноженный на 10+ порядковый номер записи у данного агента за сегодня. Таким образом номер первой записи за 25 марта 2025 года для первого агента будет 25032025101.
Мои записи.
При переходи в блок «мои записи» отображать записи, которые совершил агент но которые ещё не прошли, то есть необходимо продублировать все информацию по ещё не пройденным ТО. 
Так же отображать сумму всех СТО из этого списка.    
Самой первой строкой отображать баланс агента ((сумма всех карточек ТО, которые имеют согласование об успешности прохождения от администратора минус комиссия агента (из блок информации об Агенте)) и минус сумма выплат карточек расчёта от агента админу, её прописывает админ в боте.
После согласование прохождения ТО агенту приходит информация об успешности прохождения ТО и из баланса агента списывается сумма согласованного ТО.
Архив.
В данном блоке блоке отображается информация о всех «Карточках ТО» и «Карточках расчёта».
Функционал Администратора:
Администратор имеет весь функционал «Агента» и так же должен пройти регистрацию. 
Дополнительно у пользователей с ролью администратор есть блок «Админ панель».

Админ панель:
Админ панель состоит из блоков «согласование» и «список агентов». 
Блок «Согласование». Тут отображаться информация об активных записях (карточках ТО), заведённых агентами, их можно или согласовать или отклонить, данная информация будет отражена в карточке записи и показана агенту. А баланс агента после согласование уменьшиться на сумму в карточке ТО. Если Админ выбирает «отклонить» карточку ТО, он пишет комментарий к данной карточке который придёт агенту. Как только Агент создаёт новую «карточку ТО» она приходит сообщением всем администраторам и попадает в блок «Согласование».
Списка агентов (отображать по 30 штук, следующие 30 штук дополнительной кнопкой) кнопкой. Список агентов должен быть реализован по принципу взаимодействующей сущности. С каждым агентом можно совершить 3 действия. 
1) Info: Агент 1  - вывести информацию о агенте фио, название компании, ссылка на месенджер (добавляется админами через базу данных), вывести количеств согласованных ТО (увеличивать после согласования админом и уменьшать в случае исправление в разделе action) по аналогии выводить не успешные ТО, баланс агента 1, ставка комиссии агента 1, сумму комиссионных агентом 1, это расчётное значение которое изменяется после того как карточка ТО приобретает статус «согласованно» путём прибавления процент комиссии от сумма ТО, если карточку ТО поменяли в разделе «Action» нужно пересчитать комиссионные для агента начиная с первой согласованной записи.
2) Archive: Агент 1 – вывести все карточки ТО агента (с флагом прохождения согласовано/отказано, если он не определён так и написать) и записи карточки расчётов с агентом. Всю эту информацию выводить обычным тексом, можно в несколько сообщений в случае большого количества записей.
3) Action: Агент 1 – Три блока действия. 1)Добавить карточку расчёта, при нажатии на которое можно ввести сумму (если сумма не целая вводить со знаком разделения запятая (вывести об этом информацию и сделать валидацию)), полученную от агента, в случае корректировке со знаком минус и далее число без символов например «-1000» или «3000» или «1500,50», после ввода суммы пишется комментарий к карточке расчёта. 2)Извинить карточку ТО, вводим номер карточки ТО и появляться возможность заполнить карточку заново, но важно сделать для каждого вопроса кнопку «оставить прежнее значение» и сразу добавить блок «согласования» с дополнительным комментарием к карточке. 3) Изменить комиссию Агента 1, тут возможно ввести новое значение комиссии, если комиссия не целая, то вводить со знаком разделения запятая (вывести об этом информацию и сделать валидацию) пример ввода «25» или «21,5».
Состав команд бота.  
При отправке сообщения которое бот не может обработать выводить сообщение об этом и предложение воспользоваться командой /start.
Команда /start выводит главное меню бота для агента и админа, если они зарегистрированы. Если пользователь не зарегистрирован предложить команду /register.
Команда /register запускает Процесс регистрации нового Агента. 
Пожелания по структуре проекта:
 Если функцию можно вынести в отдельный класс, это необходимо сделать, чтобы проект было удобно читать и поддерживать. В проекте должен быть файл гит игнора что бы лишняя информация не попала в открытый доступ.  
Сделать отдельный блок с Логированием работы бота с 2 режимами работы DEBUG и INFO. 
Режим DEBUG является режимом по умолчанию максимально подробно логирует каждое действие пользователя в формате «ожидаемый результат – фактический результат» и выводит эту информацию в консоль что бы оперативно исправлять недочёты.
Режим INFO выводит логи в файл, и при достижение ими размера в 300 мб, архивирует их и начинает новый файл, данный режим нужен для разворачивании на сервере и разбора ситуаций когда что-то пошло не так в продакшене. И нужно будет грепать логи через консоль по многим файлам. Сделай отдельный файл по структуре логирования, что где и зачем, что бы человек который впервые открыл проект мог прочитать логи. 
 
База данных должна быть PostgreSQL и пропиши в фаайле ReadMe механизм подключения к БД через dbeaver. Так же предусмотри возможность того что бд может быть в отдельном контейнере (на продакшен сервере) и что на продакшене нужно будет обновлять только самого бота, без изменения продакшен БД. Дополнительно сделай механизм дампа БД каждый день в 22:00, и что бы это не влияло на продакшен БД возможно стоит сделать стендбай БД куда будут дублироваться записи. В отдельную папку. Использование параметризованных запросов к БД для исключение SQL-инъекций и продумать другие варианты обезображивание бота и БД. Ограничение количества запросов от одного пользователя для предотвращения DDoS-атак.
